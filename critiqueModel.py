from sklearn.neighbors import KNeighborsClassifier
import joblib
import numpy as np
import streamlit as st

# Function to calculate features (mean and standard deviation)
def calculate_features(angle_set):
    return [np.mean(angle_set), np.std(angle_set)]

# Function to train and save the classifier
def train_and_save_model(good_angles_1, good_angles_2, bad_angles_1, bad_angles_2, model_filename):
    X_train = np.array([
        calculate_features(good_angles_1),
        calculate_features(good_angles_2),
        calculate_features(bad_angles_1),
        calculate_features(bad_angles_2)
    ])
    y_train = np.array(['good', 'good', 'bad', 'bad'])
    
    knn = KNeighborsClassifier(n_neighbors=2)
    knn.fit(X_train, y_train)
    
    # Save the trained model to a file
    joblib.dump(knn, model_filename)
    print(f"Model saved to {model_filename}")

# Function to load the model and predict the class of new angles
def classify_angles(new_angles, model_filename):
    # Load the trained model from the file
    knn = joblib.load(model_filename)
    
    # Calculate features for the new set of angles
    new_features = calculate_features(new_angles)
    
    # Classify the new set of angles
    prediction = knn.predict([new_features])
    
    return prediction[0]

# Example usage:
# Assuming good_angles_1, good_angles_2, bad_angles_1, bad_angles_2 are defined:
good_angles_1 = np.array([103.84534972480118, 102.16283127037453, 89.10627004428734, 80.19006741281028, 110.93813842198792, 64.20170473839559, 108.62749716250143, 90.1395650353173, 90.78459987488708, 100.6655821431611, 100.94459072733389, 98.52040194594898, 112.46610613921617, 100.88350155271834, 88.70764254440944, 128.15187711119893, 132.38437785510632, 141.07740177527526, 137.6592448348603, 137.81075243467308, 132.9220924211738, 134.09935497114014, 133.8329070629402, 133.55805203956558, 134.72464853771928, 133.541371398631, 133.65443953434266, 132.37890525334018, 133.25423794212028, 132.41682037953268, 131.56041197213565, 131.85315208717415, 134.53819958944493, 134.13293968963114, 132.3963083363024, 130.68126725707035, 129.30761988653455, 128.94186413737333, 130.72391615179362, 128.58526640345767, 128.39329863123362, 126.49421057751334, 130.38897175687424, 132.86218586679135, 107.99603172729606, 120.47951011583194, 128.03852921228332, 109.02713928023212, 112.7216796639532, 112.93100409591308, 121.94422387025612, 135.63393193147135, 117.51297887399951, 127.72026152199956, 83.82505901625356, 111.82553592164432, 111.31840845769666, 122.89185744886001, 111.71698290441981, 109.65447189766842, 100.7208891097041, 131.98792444980631, 134.49459203655832, 89.21863040191874, 106.74916308905743, 116.45885758067767, 110.46259290485435, 106.19000166690057, 123.52317341831322, 126.32490831091405, 133.8363403264536, 137.94632157601717, 141.8951111648286, 141.3803224170143, 135.69646369009385, 137.14610284951914, 135.65200912298727, 130.49468376227713, 133.0469495466032, 135.76732768100345, 131.7463589314809, 132.0266391200617, 133.47111392602594, 133.75920305619638, 137.46020728447982, 135.5412624515249, 133.86950108458726, 128.00732208760445, 128.8803268197786, 130.840269702791, 133.68415595374523, 130.25935466661213, 136.9411604546129, 132.9043869470698, 133.4750328132027, 132.34312642956067, 130.42420092164377, 129.29402341128494, 130.5438663782402, 135.77858130629323, 115.52847223533685, 129.23774389957055, 112.1076659665741, 123.93515300990872, 127.78725994979662, 123.04548183668126, 108.16804739513609, 99.94320845207041, 102.37454956207891, 110.59077559698744, 120.22269903020768, 103.20689606504918, 98.61833199944266, 115.98813917185166, 121.97002912053756, 109.98991114877603, 110.55537986388497, 126.31587835971449, 114.95199158545687, 111.50488751304727, 129.9556736407294, 100.41564714486415, 116.4685854804559, 101.3143036522915, 114.89602630564363, 97.58452049116178, 140.6099931124925, 141.64861526463878, 139.5962471531855, 133.54960333424768, 133.93449596068504, 142.31122400009474, 139.64009994530312, 135.65712214271394, 137.3947711217158, 134.33171687695614, 132.23980999105126, 134.86899381516596, 134.0190079313186, 134.5919287435672, 131.67128733880384, 129.58660478891585, 130.06393700546312, 131.00508005408068, 132.25247434686096, 135.43101274439917, 141.52652521516382, 134.73252033282037])
good_angles_2 = np.array([120.40170283939922, 124.27246824138633, 125.5756101847003, 117.51335933621401, 118.48688277803815, 116.00230917918704, 111.19299580114716, 106.03276391231576, 105.06508431487727, 102.23504481141835, 106.14516232099284, 100.08846822981832, 85.24471763820472, 72.99134235129593, 69.54424275891135, 74.3779609140531, 72.39797931088329, 65.30555721609598, 76.76928638683523, 98.12595045808663, 128.15792617720734, 120.04430052083781, 108.93024390092718, 105.62171719199219, 92.29277750085032, 85.32080801979903, 82.71477745798043, 73.02435259513128, 76.20111227988079, 78.21964064969495, 84.5267375984527, 87.63182338411727, 96.78176438162859, 113.26948746369925, 116.82941449199699, 112.00239221967631, 105.0687692306311, 110.25753105901579, 111.35828271382427, 114.06879993397557, 110.33146576980953, 118.54755968592835, 127.48779306323888, 132.3846084096064, 128.99536482457538, 129.12418560016604, 121.2430662229006, 132.33255233457064, 131.75427501119614, 135.12431949888892, 135.51771577242224, 133.30817140831184, 128.1379679421139, 126.14480947153717, 130.32096883344713, 125.89463417056537, 124.44044815003191, 128.91119665005834, 128.73896541975063, 129.29208461961142, 129.96138344396698, 122.38012645260329, 116.35074257089182, 112.59620267260601, 106.455198348811, 109.85223620973018, 114.07707175993725, 118.59992646765555, 112.73945977265195, 100.87768772616568, 100.9302197362371, 93.27311277314077, 83.61800778516223, 81.17692893704631, 74.91140097932237, 76.34924207913899, 77.34590591703457, 60.7662484034261, 81.24735134366802, 49.36815467762115, 63.26895182794286, 62.600877907593585, 58.00805710895974, 116.78967007138547, 75.21103922509731, 77.73078240770717, 86.20436614169436, 88.64182774646048, 106.93262480638151, 84.52357400432861, 82.94768670028014, 81.5686536048568, 78.4315176010244, 80.59732068245326, 87.22338126777485, 96.79972522350315, 104.64613506585877, 118.04045636314208, 118.75529424338407, 121.39982972550922, 117.9852615907783, 117.59289495162044, 117.03070055854572, 118.364541956386, 121.39767048422162, 129.26915481784926, 128.60610494002643, 128.23156589994454, 135.47529038031027, 133.3764984584927, 136.18119969705174, 136.50606229872002, 132.46302776922113, 124.89930701971784, 131.53410155060755, 133.2624371389628, 130.87239447224113, 128.2832382185442, 130.90422758948492, 133.7819691393623, 130.7451145862684, 126.9541620892263, 135.0443791306497, 130.28972762967732, 122.23545174281901, 121.36932297933502, 117.22957440404315, 118.97673688084782, 109.66981947568141, 106.10049304109945, 101.41433617620939, 92.23423571939581, 84.33559147148502, 85.83204376352123, 82.57567496638366, 81.58053221782106, 77.6717166597701, 77.278773837372, 99.02221140749387, 97.53801836464032, 117.86610935283194, 120.68125651896982, 113.93527046816018, 116.76983333335441, 113.08892569500244, 107.26336266953737, 74.5056906462327, 78.4768400266637, 71.80570704259088, 74.71381647550365, 73.25449416566173, 77.7192184634716, 85.03261284003159, 88.52846068001284, 97.68382517198943, 102.63475920603518, 111.78837785402433, 111.75780974894674, 108.13093495821862])
bad_angles_1 = np.array([113.36197952743402, 112.86442107103406, 112.16582171839015, 135.70471178602693, 113.2863045978932, 129.92178810902718, 120.27329897019025, 118.53354050661906, 115.30837328338023, 113.9107733105329, 119.36980776472346, 106.19556989961976, 99.09811599615843, 91.67797784492157, 124.40259567903009, 125.39150034352895, 127.36198226198768, 122.67229714581711, 130.55143102009046, 120.41622349160983, 113.77006038657954, 122.56039114322175, 130.7724838294838, 129.36334618936527, 128.24350614161912, 124.48378471705674, 115.95740671329621, 111.65077537670177, 115.66263118370175, 114.1288935830192, 122.60316328728136, 111.87211013027827, 121.40383442134039, 119.57826592092017, 117.64693607610205, 119.7408131776525, 112.30491385135676, 116.45238033820291, 116.27184220002259, 102.0892434495785, 101.6481206690584, 103.84529928835383, 119.98302991040327, 115.72098168716938, 114.16732726467463, 114.61931396618088, 105.04192549551149, 119.67209542577847, 119.56390573805717, 115.99400384772035, 131.46846105968484, 134.9451540725248, 132.39560822080603, 120.22561545920614, 108.46663601372194, 104.20590807206355, 124.9990938788216, 133.85685639019252, 132.86419605439363, 132.90279685355364, 131.82677834131204, 129.7382497787595, 127.95981968945378, 129.70363007721235, 130.06271466478495, 130.64716187026426, 129.11711442993698, 129.99980648543846, 128.5724903162117, 129.17846763383594, 129.72737261313438, 126.90534761228977, 126.16674230344523, 124.72665193118023, 123.61568664264617, 128.00159827113583, 94.56765002564424, 97.59367309167806, 104.89313395186554, 110.10194313511757, 104.29028993003199, 115.71143378710413, 120.66321443944875, 108.78409939308041, 118.62678681669816, 120.74789574426866, 90.70180700279315, 95.16944765421984, 97.53412606213448, 120.69189716702805, 114.82053292746468, 114.3139690778933, 114.71317244882091, 137.70940059251726, 125.09998092266146, 120.22712189219321, 127.10714062448568, 113.25106467506171, 83.40268774260878, 70.48773369395421, 116.30610042903753, 83.55592365868948, 114.01605006472592, 121.24070672056108, 113.51111214519898, 112.21046906840375, 108.76688768691552, 107.05554063854564, 102.4550023823042, 83.33903464259929, 70.32639597109133, 87.83982866292386, 88.46038698089521, 115.285775018252, 111.56513532215553, 109.40035346278077, 108.97243965535885, 107.56890239979735, 105.04380051408027, 112.44343238943382, 110.84242037806035, 109.55096527193503, 105.58775577957296, 88.13257752730283, 68.32620309723184, 61.17283795854245, 72.92761550282916, 91.55776625614823, 93.99987255699085, 109.96298491436502, 104.76416423651465, 100.0906485142289, 117.97632868524806, 114.65036380826933, 127.48947267806938, 133.21612566237135, 107.19541251856491, 98.25133660184513, 95.52494760303361, 129.6020567572825, 133.38280935432593, 105.88657173763333, 99.68673635886597, 109.77303988691098, 109.81884743988455, 105.13720707902382, 95.14574095180988, 95.69826619035926, 111.81875769971813, 120.51223084139681, 115.3691490122348, 117.16512877813597, 97.03802438278852, 102.78820405223435, 128.28710044440996, 127.5109092363227, 129.41640453242104, 139.32036672748322])
bad_angles_2 = np.array([114.23740222968145, 119.3787340664432, 123.36004984441783, 128.69616076250537, 128.8873750887125, 131.76068614396817, 132.27380089789233, 134.35372681172015, 133.78744644149822, 133.36471108419053, 128.50737173825107, 124.4365127787112, 122.94254026971736, 117.42465846427335, 118.20075651985523, 118.22420813302163, 115.31652610354925, 112.93160319522568, 113.1163179275585, 112.27572735558601, 108.86924797407485, 109.366123848479, 105.34318695134286, 107.11897981706075, 96.1052499863335, 94.62456018026276, 105.85421556980143, 104.65091851365688, 109.32163196204478, 108.87784303030378, 110.45768420632592, 118.9665127221393, 119.66447448919506, 124.83271796396009, 127.97221695391633, 129.84184991949257, 137.2293341622606, 137.0592271207116, 133.34817953495224, 132.08564368155737, 133.86816520707052, 132.8820621484931, 130.9620771022964, 127.82382973389016, 128.09409547553085, 125.13154559730555, 122.94110637379949, 123.31992155272734, 124.04423286407848, 126.29311176708093, 126.62742003494685, 125.46007723048537, 119.36382871304413, 110.22464843213291, 110.34724514311164, 109.30229293696405, 103.75498767486513, 103.74443469071475, 100.82917811403082, 102.59248797231264, 101.27470027116152, 94.89756905789201, 99.09663610398067, 94.30212160399383, 92.08121806334246, 87.60505935081363, 86.00692461204159, 89.44116362785506, 95.17172848981333, 95.60734071806822, 103.88924641868026, 107.36694200452924, 108.6594291661192, 109.46600796033597, 115.19417269285309, 116.93213334940783, 122.85854671465783, 127.30764925875755, 133.03595372432434, 132.94012413443247, 135.43186274367463, 135.15694806452115, 130.28463470935495, 128.73863004134, 128.14129897529273, 124.99040986954782, 124.77422486229062, 123.2102916153512, 123.5589195909549, 123.67189937958928, 125.38961276566468, 121.61717322660466, 125.021874016652, 119.58947537863325, 123.80228308442436, 116.72204283458342, 114.91743338097385, 107.43209059936264, 106.00041662765679, 103.77350592109548, 109.58184769306374, 110.40259291763411, 97.83950027626278, 96.0641073873402, 109.30842780849319, 110.2962264991135, 117.8738661034684, 114.76019728254302, 113.18087757512635, 118.80677997849459, 114.71803802527889, 115.21016566775194, 119.26423954907933, 120.27698685421149, 118.26116589626865, 115.6596215208908, 115.67034312228783, 109.41976273428129, 107.17049163351514, 108.19177039459757, 104.9696825888194, 106.60812839508047, 112.82403075388254, 114.83059921423339, 120.90077408525214, 120.96464688324647, 121.87871843948484, 126.42325688165151, 129.22649964926484, 129.8937069909579, 130.3433851865537, 132.1035944105225, 127.47157053024753, 136.79488853882074, 131.97852352285233, 125.13575428996943, 124.32305613769023, 125.6174950737866, 126.93895515900766, 128.29509359118734, 128.05079688737473, 128.23751680578223, 126.0281050162472, 126.06156728120531, 127.59925653270776, 130.19407047928038, 130.33449909651165, 129.51157487064458, 130.6084514688757, 129.11864654536765, 128.97336102601318, 128.45992476675127, 128.40005243154005, 130.99594031014146, 131.72219273451205, 130.93914026626075, 129.44130517332414, 130.11442442017577, 131.78483909135463, 130.92594359519973, 133.5896623758467, 131.93138138973637, 134.37799050269032, 132.09129050049452, 132.89917474722367, 131.22517375244385])

# train_and_save_model(good_angles_1, good_angles_2, bad_angles_1, bad_angles_2, 'knn_model.joblib')

# Then, when you need to classify new angles:
# new_angles = [...]  # Replace with your new angles data
# st.write(classify_angles([0, 1, 2, 3, 4, 5, 6], 'knn_model.joblib'))
# result = classify_angles(new_angles, 'knn_model.joblib')
# print(f"The new set of angles is likely {result}")
